<head>
    <link rel="stylesheet" href="/themes/light/stylesheet.css">
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script defer src="db-init.js"></script>
</head>
<body>
    <div id="loading-screen">Loading...</div>


    <div class="banner fix-top">
        <div id="currentUsers">Current Users: # | Current Room: Global</div>
    </div>
    <div class="messages-wrapper">
        <div id="messages"></div>
    </div>
    <div class="banner fix-bottom" style="height: 100px">
        <div class="ui-grid">
            <textarea class="inputs" id="message-input" placeholder="Enter your message here..."></textarea>
            <div class="inputs" id="send-button">Send</div>
        </div>
    </div>
</body>

<script defer>
    const currentUsers = document.getElementById('currentUsers')
    const loadingScreen = document.getElementById('loading-screen')
    const messageInput = document.getElementById('message-input')
    const sendButton = document.getElementById('send-button')
    const messages = document.getElementById('messages')

    const clientBadge = `&nbsp;<span class='badge client-badge'>YOU</span>`
    const systemBadge = `&nbsp;<span class='badge system-badge'>SYSTEM</span>`

    messageInput.onkeydown = e => {
        let key = e.key
        if(key === "Enter"){
            e.preventDefault()
        }
    }

    function generateToken(){
        return (Math.random().toString(36) + Math.random().toString(36)).replaceAll('0.', "")
    }

    document.body.onload = () => {

        let timedOut = false;

        let userToken = localStorage.getItem('chat-app-the-third-userToken') == null ? generateToken() : localStorage.getItem('chat-app-the-third-userToken');

        if(localStorage.getItem('chat-app-the-third-userToken') == null){
            localStorage.setItem('chat-app-the-third-userToken', userToken)
        }

        let rtdbRef = rtdb.ref("users/" + userToken)

        let roomID = "Global"

        rtdbRef.once("value", (snapshot) => {
            if(snapshot.val() == null){
                rtdbRef.set({
                    status: "online",
                    lastOnline: Date.now(),
                    room: 'Global',
                    username: userToken,
                    isAdmin: false,
                    isBanned: false,
                    userInstances: 1
                })
            } else {
                rtdbRef.update({
                    status: "online",
                    lastOnline: Date.now(),
                    room: 'Global',
                    userInstances: JSON.parse(JSON.stringify(snapshot.val().userInstances + 1))
                })
            }

            rtdb.ref("users").on("value", (snapshot) => {
                // get the children who have a status of online
                let onlineUsers = Object.values(snapshot.val()).filter((user) => user.status === "online")
                currentUsers.innerHTML = `Current Users: ${onlineUsers.length} | Current Room: Global`
                loadingScreen.style.display = "none"
            })
        })

        // onbeforeunload, deduct the userInstances by 1
        window.onbeforeunload = () => {
            rtdbRef.once("value", (snapshot) => {
                rtdbRef.update({
                    userInstances: JSON.parse(JSON.stringify(snapshot.val().userInstances - 1))
                })
                if(snapshot.val().userInstances - 1 === 0){
                    rtdbRef.update({
                        status: "offline",
                        lastOnline: Date.now()
                    })
                }
            })
        }

        function createMessage(sender, content, clientMessage){
            let div = document.createElement('div')
            let badges = ''
            if(clientMessage){
                badges += clientBadge
            }

            if(sender == 'System'){
                badges += systemBadge
            }

            div.innerHTML = `<div class="message-container">
                <div class="message-name">${sender}${badges}</div>
                <div class="message-content">${content}</div>
            </div>`

            messages.prepend(div)
        }

        let currentRoomRef = db.collection("rooms").doc(roomID)

        currentRoomRef.onSnapshot((snapshot) => {
            if(snapshot.data().messages == undefined) return;
            let newMessage = Object.values(snapshot.data().messages)[Object.values(snapshot.data().messages).length - 1]
            if(newMessage.roomID != roomID) return;
            createMessage(newMessage.senderUsername, newMessage.content, newMessage.senderToken == userToken)
        })


        sendButton.onclick = () => {
            if(timedOut) return;

            let isCommand = messageInput.value.startsWith("/")
            let isEmpty = messageInput.value.trim() === ""

            let isBanned = false

            rtdbRef.once("value", (snapshot) => {
                isBanned = snapshot.val().isBanned
            })

            

            if(isEmpty){
                return createMessage("System", "You cannot send an empty message.", false)
            }

            if(isBanned){
                return createMessage("System", "You are banned from sending messages.", false)
            }

            let username;
            rtdbRef.once("value", (snapshot) => {
                username = snapshot.val().username
            })

            currentRoomRef.set({
                messages: {
                    [Date.now()]: {
                        senderToken: userToken,
                        senderUsername: username,
                        content: messageInput.value,
                        roomID: roomID,
                        flags: {
                            isCommand: isCommand,
                        }
                    }
                }
            }, {merge: true})
        }
    }
    
</script>