<head>
    <link rel="stylesheet" type="text/css" href="./themes/light/styles.css">
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script defer src="db-init.js"></script>
</head>
<body>
    <div id="loading-screen">Loading...</div>


    <div class="banner fix-top">
        <div id="currentUsers">Current Users: # | Current Room: Global</div>
    </div>
    <div class="messages-wrapper">
        <div id="messages">
            <div class="message-container">
                <div class="message-head">${sender}&nbsp;${badgeDisplay}&nbsp;<div class="time-display">02/10/2023 at 15:15:20</div></div>
                <div class="message-content">${content}</div>
            </div>
        </div>
    </div>
    <div class="banner fix-bottom" style="height: 100px">
        <div class="ui-grid">
            <textarea class="inputs" id="message-input" placeholder="Enter your message here..." spellcheck="false"></textarea>
            <div class="inputs" id="send-button">Send</div>
        </div>
    </div>
</body>

<script defer>
    const currentUsers = document.getElementById('currentUsers')
    const loadingScreen = document.getElementById('loading-screen')

    const messageInput = document.getElementById('message-input')
    const sendButton = document.getElementById('send-button')
    const messages = document.getElementById('messages')

    messageInput.onkeydown = e => {
        let key = e.key
        if(key === "Enter"){
            e.preventDefault()
        }
    }

    function generateToken(){
        return (Math.random().toString(36) + Math.random().toString(36)).replaceAll('0.', "")
    }

    function getDateAndTime(){
        let year = new Date().getFullYear()
        let month = String(new Date().getMonth() + 1).padStart(2, '0')
        let day = String(new Date().getDate()).padStart(2, '0')

        let hours = String(new Date().getHours()).padStart(2, '0')
        let minutes = String(new Date().getMinutes()).padStart(2, '0')
        let seconds = String(new Date().getSeconds()).padStart(2, '0')

        return {
            year: year,
            month: month,
            day: day,
            hours: hours,
            minutes: minutes,
            seconds: seconds,
            timestamp: `${day}/${month}/${year} at ${hours}:${minutes}:${seconds}`
        }
    }

    const customBadges = {
        'test': "TESTER",
        'hurr-durr': 'hurr durr im a returd!',
        'admin': 'ADMIN',
        'invis': 'invisible!'
    }

    document.body.onload = () => {

        let timedOut = false;

        let userToken = localStorage.getItem('chat-app-the-third-userToken') == null ? generateToken() : localStorage.getItem('chat-app-the-third-userToken');

        if(localStorage.getItem('chat-app-the-third-userToken') == null){
            localStorage.setItem('chat-app-the-third-userToken', userToken)
        }

        let rtdbUserRef = rtdb.ref("users/" + userToken)
        let rtdbUsageDataRef = rtdb.ref("usage-data")

        let roomID = "Global"

        rtdbUserRef.once("value", (snapshot) => {
            if(snapshot.val() == null){
                rtdbUserRef.set({
                    status: "online",
                    room: 'Global',
                    username: userToken,
                    token: userToken,
                    isAdmin: false,
                    isBanned: false,
                    userInstances: 1,
                    badges: ['filler'],
                    timeSinceLastMessage: 0,
                })
            } else {
                rtdbUserRef.update({
                    status: "online",
                    room: 'Global',
                    userInstances: JSON.parse(JSON.stringify(snapshot.val().userInstances + 1)),
                })
            }

            rtdb.ref("users").on("value", (snapshot) => {
                // get the children who have a status of online
                let onlineUsers = Object.values(snapshot.val()).filter((user) => user.status === "online" && user.room === roomID)
                currentUsers.innerHTML = `Current Users: ${onlineUsers.length} | Current Room: Global`
                loadingScreen.style.display = "none"
            })
        })

        let DnT = getDateAndTime()
        let currentRoomRef = rtdb.ref(`rooms/${roomID}/messages/${DnT.year}/${DnT.month}/${DnT.day}`)

        window.onbeforeunload = () => {
            rtdbUserRef.once("value", (snapshot) => {
                rtdbUserRef.update({
                    userInstances: JSON.parse(JSON.stringify(snapshot.val().userInstances - 1))
                })
                if(snapshot.val().userInstances - 1 === 0){
                    rtdbUserRef.update({
                        status: "offline",
                    })
                }
            })
        }

        function getBadge(name, displayText){
            return `&nbsp;<span class='badge ${name}-badge'>${displayText}</span>`
        }

        function createMessage(data, clientMessage){
            let div = document.createElement('div')
            let badgeDisplay = ''
            if(clientMessage){
                badgeDisplay += getBadge("client", "YOU")
            }

            if(data.sender == 'System'){
                badgeDisplay += getBadge("system", 'SYSTEM')
            }

            if(data.badges != undefined){
                data.badges.forEach((badge) => {
                    if(badge == 'filler') return;
                    badgeDisplay += getBadge(badge, customBadges[badge])
                })
            }

            div.innerHTML = `<div class="message-container">
                <div class="message-head">${data.sender}&nbsp;${badgeDisplay}&nbsp;&nbsp;<div class="time-display">${DnT.timestamp}</div></div>
                <div class="message-content">${data.content}</div>
            </div>`

            messages.prepend(div)
        }



        createMessage({
            sender: "System",
            content: "Welcome to the chat!",
            timestamp: DnT.timestamp
        }, false)

        function submitMessage(){

            let isCommand = messageInput.value.startsWith("/")
            let isEmpty = messageInput.value.trim() === ""

            let isBanned = false

            rtdbUserRef.once("value", (snapshot) => {
                isBanned = snapshot.val().isBanned
            })

            

            if(isEmpty){
                let data = {
                    sender: "System",
                    content: "You cannot send an empty message.",
                    timestamp: DnT.timestamp,
                }
                return createMessage(data, false)
            }

            if(isBanned){
                let data = {
                    sender: "System",
                    content: "You are banned from sending messages.",
                    timestamp: DnT.timestamp,
                }
                return createMessage(data, false)
            }


            if(timedOut) return;
            let username;

            rtdbUserRef.once("value", (snapshot) => {
                username = snapshot.val().username
            })

            let senderBadges;

            rtdbUserRef.on("value", (snapshot) => {
                senderBadges = snapshot.val().badges
            })

            currentRoomRef.update({
                [Date.now()]: {
                    senderToken: userToken,
                    senderUsername: username,
                    content: messageInput.value,
                    roomID: roomID,
                    flags: {
                        isCommand: isCommand,
                    },
                    timestamp: DnT.timestamp,
                    badges: senderBadges
                }
            })

            messageInput.value = ""

        }

        currentRoomRef.on("child_added", (snapshot) => {
            if(snapshot.val() == null) return;
            let message = snapshot.val()
            let clientMessage = message.senderToken === userToken

            let data = {
                sender: message.senderUsername,
                content: message.content,
                timestamp: message.timestamp,
                badges: message.badges,
                token: message.senderToken
            }

            createMessage(data, clientMessage)
        })

        sendButton.onclick = () => {
            submitMessage();
        };

        messageInput.onkeyup = e => {
            let key = e.key
            if(key === "Enter"){
                submitMessage();
            }
        }

        
        // get all online users
        rtdb.ref("users").on("value", (snapshot) => {
            rtdbUsageDataRef.update({
                onlineUsers: Object.values(snapshot.val()).filter((user) => user.status === "online").length
            })
        })


    }
    
</script>