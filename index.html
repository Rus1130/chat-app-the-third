<head>
    <link rel="stylesheet" href="style-lighttheme.css">
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script defer src="db-init.js"></script>
</head>
<body>
    <div id="loading-screen">Loading...</div>

    <div class="banner info">
        <div id="currentUsers">Current Users: # | Current Room: Global</div>
    </div>
    <div class="banner ui">
        <div class="ui-grid">
            <textarea class="inputs" id="message-input" placeholder="Enter your message here..."></textarea>
            <div class="inputs" id="send-button">Send</div>
        </div>
    </div>

<script defer>
    const currentUsers = document.getElementById('currentUsers')
    const loadingScreen = document.getElementById('loading-screen')
    const messageInput = document.getElementById('message-input')
    const sendButton = document.getElementById('send-button')

    const newUserEveryTab = false;

    messageInput.onkeydown = e => {
        let key = e.key
        if(key === "Enter"){
            e.preventDefault()
        }
    }

    function generateToken(){
        return (Math.random().toString(36) + Math.random().toString(36)).replaceAll('0.', "")
    }
    

    document.body.onload = () => {
        let userToken = localStorage.getItem('chat-app-the-third-userToken') == null ? generateToken() : localStorage.getItem('chat-app-the-third-userToken');

        if(localStorage.getItem('chat-app-the-third-userToken') == null){
            localStorage.setItem('chat-app-the-third-userToken', userToken)
        }

        let rtdbRef = rtdb.ref("users/" + userToken)

        let localInstances = 0;

        // check if the user is already in the database
        rtdbRef.once("value", (snapshot) => {
            if(snapshot.val() == null){
                rtdbRef.set({
                    status: "online",
                    instances: 1,
                    lastOnline: Date.now(),
                    room: 'Global',
                    username: userToken,
                    isAdmin: false
                })
                localInstances = 1;
            } else {
                rtdbRef.update({
                    status: "online",
                    instances: snapshot.val().instances + 1,
                    lastOnline: Date.now()
                })

                localInstances++;
            }
            rtdb.ref("users").on("value", (snapshot) => {
                // get the children who have a status of online
                let onlineUsers = Object.values(snapshot.val()).filter((user) => user.status === "online")
                currentUsers.innerHTML = `Current Users: ${onlineUsers.length} | Current Room: Global`
                loadingScreen.style.display = "none"
            })
        })

        rtdbRef.on("value", (snapshot) => {
            rtdbRef.onDisconnect().update({
                status: (snapshot.val().instances - 1) === 0 ? "offline" : "online",
                instances: snapshot.val().instances - 1,
                lastOnline: Date.now()
            })
        })

    }
    
</script>